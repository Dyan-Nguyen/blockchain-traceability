# ğŸ—ï¸ KIáº¾N TRÃšC Há»† THá»NG BLOCKCHAIN TRACEABILITY

## ğŸ“Š Tá»”NG QUAN KIáº¾N TRÃšC

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      NGÆ¯á»œI DÃ™NG / USER LAYER                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  NÃ´ng dÃ¢n   â”‚ Doanh    â”‚  Váº­n     â”‚  SiÃªu    â”‚  NgÆ°á»i tiÃªu dÃ¹ng â”‚
â”‚  ğŸ‘¨â€ğŸŒ¾        â”‚  nghiá»‡p  â”‚  chuyá»ƒn  â”‚  thá»‹     â”‚  & Quáº£n lÃ½ ğŸ‘¤ğŸ“Š  â”‚
â”‚             â”‚  ğŸ­      â”‚  ğŸšš      â”‚  ğŸª      â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†•ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FRONTEND LAYER (public/)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ index.html  - Giao diá»‡n chÃ­nh (tabs Ä‘a vai trÃ²)              â”‚
â”‚  â€¢ trace.html  - Trang truy xuáº¥t cho QR code                    â”‚
â”‚  â€¢ app.js      - Logic xá»­ lÃ½ frontend                           â”‚
â”‚  â€¢ styles.css  - UI/UX responsive                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†•ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              API LAYER (server.js)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  REST API Endpoints:                                             â”‚
â”‚  â€¢ POST /api/batch             - Táº¡o lÃ´ sáº£n pháº©m                â”‚
â”‚  â€¢ POST /api/farming/:id       - ChÄƒm sÃ³c                       â”‚
â”‚  â€¢ POST /api/harvest/:id       - Thu hoáº¡ch                      â”‚
â”‚  â€¢ POST /api/quality/:id       - Kiá»ƒm Ä‘á»‹nh                      â”‚
â”‚  â€¢ POST /api/packaging/:id     - ÄÃ³ng gÃ³i                       â”‚
â”‚  â€¢ POST /api/transport/:id     - Váº­n chuyá»ƒn                     â”‚
â”‚  â€¢ POST /api/warehouse/:id     - Nháº­p/Xuáº¥t kho                  â”‚
â”‚  â€¢ GET  /api/batch/:id         - Truy xuáº¥t lÃ´                   â”‚
â”‚  â€¢ GET  /api/qrcode/:id        - Táº¡o QR code                    â”‚
â”‚  â€¢ GET  /api/statistics        - Dashboard                      â”‚
â”‚  â€¢ GET  /api/validate          - Kiá»ƒm tra blockchain            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†•ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           BLOCKCHAIN LAYER (blockchain.js)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Block Class    - Cáº¥u trÃºc block (index, timestamp, data,     â”‚
â”‚                     previousHash, hash)                          â”‚
â”‚  â€¢ Blockchain     - Chain management, validation                â”‚
â”‚  â€¢ SHA-256        - Cryptographic hashing                       â”‚
â”‚  â€¢ Validation     - Integrity checking                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†•ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           STORAGE LAYER (data/chain.json)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ File-based storage                                            â”‚
â”‚  â€¢ JSON format                                                   â”‚
â”‚  â€¢ Persistent data                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ LUá»’NG Dá»® LIá»†U (DATA FLOW)

### 1. Táº O LÃ” Sáº¢N PHáº¨M (Create Batch)

```
NÃ´ng dÃ¢n (Frontend)
    â†“
    Form: batchId, product, producer, farmLocation, area...
    â†“
    POST /api/batch
    â†“
    Server validates input
    â†“
    Blockchain.addBlock({type: 'batch', ...})
    â†“
    Create new Block:
    - index = lastBlock.index + 1
    - timestamp = now()
    - previousHash = lastBlock.hash
    - hash = SHA-256(...)
    â†“
    Save to data/chain.json
    â†“
    Return block to frontend
    â†“
    Display result
```

### 2. GHI NHáº¬N HOáº T Äá»˜NG (Log Activity)

```
User (Any role)
    â†“
    POST /api/{endpoint}/:batchId
    â†“
    Server validates batchId exists
    â†“
    Blockchain.addBlock({type: 'activity', ...})
    â†“
    Append to chain
    â†“
    Save to file
    â†“
    Return confirmation
```

### 3. TRUY XUáº¤T & QR CODE (Trace & QR)

```
Consumer
    â†“
    Scan QR Code OR Enter batchId
    â†“
    GET /api/batch/:batchId
    â†“
    Blockchain.findBatch(batchId)
    â†“
    Filter all blocks with matching batchId
    â†“
    Return full history array
    â†“
    Frontend displays timeline
```

### 4. Táº O QR CODE

```
User requests QR
    â†“
    GET /api/qrcode/:batchId
    â†“
    Check if batch exists
    â†“
    Generate trace URL
    â†“
    QRCode.toDataURL(url)
    â†“
    Return base64 image
    â†“
    Display QR on screen
```

---

## ğŸ” Báº¢O Máº¬T & TOÃ€N Váº¸N (Security & Integrity)

### Blockchain Validation

```javascript
isChainValid() {
  for (let i = 1; i < chain.length; i++) {
    const current = chain[i];
    const previous = chain[i-1];
    
    // 1. Kiá»ƒm tra hash cá»§a block hiá»‡n táº¡i
    if (current.hash !== current.computeHash()) {
      return false; // Block bá»‹ thay Ä‘á»•i!
    }
    
    // 2. Kiá»ƒm tra liÃªn káº¿t vá»›i block trÆ°á»›c
    if (current.previousHash !== previous.hash) {
      return false; // Chain bá»‹ phÃ¡ vá»¡!
    }
  }
  return true; // Chain há»£p lá»‡
}
```

### Hash Computation

```javascript
SHA-256(
  block.index + 
  block.timestamp + 
  JSON.stringify(block.data) + 
  block.previousHash
)
```

**Äáº·c Ä‘iá»ƒm:**
- Thay Ä‘á»•i 1 kÃ½ tá»± â†’ Hash hoÃ n toÃ n khÃ¡c
- KhÃ´ng thá»ƒ Ä‘áº£o ngÆ°á»£c (one-way function)
- Deterministic (cÃ¹ng input â†’ cÃ¹ng output)

---

## ğŸ“¦ Cáº¤U TRÃšC Dá»® LIá»†U (Data Structures)

### Block Structure

```javascript
{
  index: 5,
  timestamp: "2025-11-26T10:30:00.000Z",
  data: {
    type: "farming",
    batchId: "LOT-2025-001",
    actor: "Nguyá»…n VÄƒn A",
    activity: "fertilizing",
    fertilizer: "NPK 16-16-8",
    pesticide: "Confidor 200SL",
    notes: "..."
  },
  previousHash: "abc123def456...",
  hash: "789xyz012abc..."
}
```

### Data Types

```javascript
types = [
  'batch',      // Táº¡o lÃ´
  'farming',    // ChÄƒm sÃ³c
  'harvest',    // Thu hoáº¡ch
  'quality',    // Kiá»ƒm Ä‘á»‹nh
  'packaging',  // ÄÃ³ng gÃ³i
  'transport',  // Váº­n chuyá»ƒn
  'warehouse',  // Nháº­p/Xuáº¥t kho
  'log'         // Log tÃ¹y chá»‰nh
]
```

### Chain File (data/chain.json)

```json
[
  {
    "index": 0,
    "timestamp": "2025-11-26T09:00:00.000Z",
    "data": { "info": "Genesis Block" },
    "previousHash": "0",
    "hash": "genesis123..."
  },
  {
    "index": 1,
    "timestamp": "2025-11-26T10:00:00.000Z",
    "data": {
      "type": "batch",
      "batchId": "LOT-2025-001",
      ...
    },
    "previousHash": "genesis123...",
    "hash": "abc456..."
  }
]
```

---

## ğŸ¯ DESIGN PATTERNS

### 1. Singleton Pattern (Blockchain)

```javascript
// server.js
const ledger = new Blockchain(); // Duy nháº¥t 1 instance
```

### 2. Factory Pattern (Block Creation)

```javascript
class Block {
  constructor(index, timestamp, data, previousHash) {
    this.index = index;
    this.timestamp = timestamp;
    this.data = data;
    this.previousHash = previousHash;
    this.hash = this.computeHash();
  }
}
```

### 3. Chain of Responsibility (Block Linking)

```
Genesis â†’ Block1 â†’ Block2 â†’ Block3 â†’ ...
   â†“         â†“         â†“         â†“
  hash â†’ prevHash â†’ prevHash â†’ prevHash
```

---

## âš¡ PERFORMANCE CONSIDERATIONS

### Current Implementation (Small Scale)

- **Storage:** File-based (chain.json)
- **Query:** Linear search O(n)
- **Scalability:** ~10,000 blocks OK
- **Concurrency:** Single-threaded

### Optimization Strategies

#### 1. Indexing
```javascript
// ThÃªm index cho batchId
batchIndex = {
  'LOT-2025-001': [1, 5, 8, 12, 15],  // block indices
  'LOT-2025-002': [2, 6, 9]
}
```

#### 2. Caching
```javascript
// Cache recent queries
const cache = new Map();
cache.set(batchId, history);
```

#### 3. Database Migration
```javascript
// Chuyá»ƒn sang MongoDB/PostgreSQL
// LÆ°u má»—i block nhÆ° má»™t document/row
```

---

## ğŸ”® NÃ‚NG Cáº¤P TRONG TÆ¯Æ NG LAI

### Phase 1: Enhanced Security
- [ ] User authentication (JWT)
- [ ] Role-based access control (RBAC)
- [ ] Digital signatures cho má»—i transaction
- [ ] Proof of Authority consensus

### Phase 2: Scalability
- [ ] Database integration (MongoDB/PostgreSQL)
- [ ] Redis caching
- [ ] Load balancing
- [ ] Microservices architecture

### Phase 3: Distributed System
- [ ] Multiple nodes
- [ ] Peer-to-peer networking
- [ ] Consensus mechanism (PoW/PoS/PoA)
- [ ] Byzantine fault tolerance

### Phase 4: Smart Contracts
- [ ] Ethereum/Hyperledger integration
- [ ] Automated business logic
- [ ] Token economics
- [ ] IoT integration (sensors)

### Phase 5: Advanced Features
- [ ] IPFS for images/documents
- [ ] Machine Learning analytics
- [ ] Predictive quality analysis
- [ ] Supply chain optimization
- [ ] Mobile app (React Native)
- [ ] Blockchain explorer UI

---

## ğŸŒ DEPLOYMENT ARCHITECTURE

### Development
```
localhost:3000
â”œâ”€â”€ Node.js server
â””â”€â”€ File storage (data/chain.json)
```

### Production (Option 1: Single Server)
```
Cloud Server (DigitalOcean/AWS)
â”œâ”€â”€ Nginx (reverse proxy)
â”œâ”€â”€ Node.js (PM2 process manager)
â”œâ”€â”€ PostgreSQL (data storage)
â””â”€â”€ SSL/TLS (Let's Encrypt)
```

### Production (Option 2: Microservices)
```
Load Balancer
â”œâ”€â”€ API Gateway
â”œâ”€â”€ Blockchain Service (Node 1, 2, 3)
â”œâ”€â”€ QR Service
â”œâ”€â”€ Database Cluster
â””â”€â”€ Redis Cache
```

---

## ğŸ“Š MONITORING & LOGGING

### Metrics to Track
- Total blocks
- Blockchain size (MB)
- API response time
- Error rate
- Active batches
- User activity

### Logging Strategy
```javascript
// Winston logger
logger.info('Block added', { batchId, index });
logger.error('Validation failed', { error });
logger.warn('Large chain size', { blocks: 50000 });
```

---

## ğŸ§ª TESTING STRATEGY

### Unit Tests
```javascript
describe('Blockchain', () => {
  it('should create genesis block', () => {
    const bc = new Blockchain();
    expect(bc.chain.length).toBe(1);
  });
  
  it('should validate chain', () => {
    expect(bc.isChainValid()).toBe(true);
  });
});
```

### Integration Tests
```javascript
describe('API', () => {
  it('POST /api/batch should create batch', async () => {
    const res = await request(app)
      .post('/api/batch')
      .send({ batchId: 'TEST', product: 'Test' });
    expect(res.status).toBe(200);
  });
});
```

---

## ğŸ“š TECHNOLOGY STACK

| Layer | Technology | Purpose |
|-------|-----------|---------|
| Frontend | HTML5, CSS3, JavaScript | User interface |
| Backend | Node.js, Express | REST API server |
| Blockchain | Custom (SHA-256) | Data integrity |
| QR Code | qrcode library | QR generation |
| Storage | File system (JSON) | Persistence |
| Crypto | Node crypto module | Hashing |

---

## ğŸ”— INTEGRATION POINTS

### 1. External Systems
- ERP systems (via REST API)
- IoT sensors (MQTT/HTTP)
- Payment gateways
- Certification bodies

### 2. Third-party Services
- SMS notifications (Twilio)
- Email (SendGrid)
- Cloud storage (AWS S3)
- Maps (Google Maps API)

---

**ğŸ“– Document Version: 2.0**  
**Last Updated: November 26, 2025**  
**Author: Blockchain Traceability Team**
